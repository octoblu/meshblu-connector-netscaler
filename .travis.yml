language: cpp
os:
- linux
- osx
addons:
  apt:
    sources:
    - ubuntu-toolchain-r-test
    packages:
    - g++-4.8
    - g++-4.8-multilib
    - gcc-multilib
    - build-essential
    - libbluetooth-dev
    - libudev-dev
    - libusb-1.0-0-dev
env:
  global:
  - DEBUG_CORE_DUMP="true"
  matrix:
  - PACKAGER_NODE_VERSION="5.5" PACKAGER_ARCH="amd64" MAIN_BUILD="true"
  - PACKAGER_NODE_VERSION="5.5" PACKAGER_ARCH="386"
matrix:
  fast_finish: true
  exclude:
  - os: osx
    env: PACKAGER_NODE_VERSION="5.5" PACKAGER_ARCH="386"
branches:
  only:
  - "/^v[0-9]/"
before_install:
- ulimit -c unlimited -S
- PACKAGER_URL="https://meshblu-connector.octoblu.com/tools/packager/latest"
- curl -fsS "${PACKAGER_URL}/travis_install_node.sh" -o /tmp/travis_install_node.sh
- chmod +x /tmp/travis_install_node.sh
- ". /tmp/travis_install_node.sh"
- if [ "$TRAVIS_OS_NAME" == "linux" -a "$MAIN_BUILD" == "true" ]; then export NPM_PUBLISH="true"; fi
install:
- npm install --build-from-source
script:
- npm test
before_deploy:
- npm prune --production
- npm install meshblu-connector-packager
- npm dedupe
- npm install -g flatten-packages
- flatten-packages
- npm run generate:package
- npm run generate:schema
- cp schemas.json deploy
deploy:
- provider: releases
  api_key:
    secure: "xTNpkjVdL3Mpy8Y/EMni0rKVqDMaIdYf8fgfowf0WqPmbbVIbvmJhXvR3MUS5Qz5bzD6L1axK9IJroaLljrVnrYPBYt3xY/x7DXHrndCfZzOlp7ZiN+htolfWaGI+nvHdOjIooYUS5iDp1wc0y2arqpRYKhGBiKd/MjBNzJda7NatWPcB3uEYZU9JKr+ZjRMToXJKyjgW1OiKuRq+FwIniuyM2R5PqvoA6g9mebIj7BIFipi9Tsl1PzBTiAFLsX47gUZJlMpWNns0/qcKqDq7HvjKVIwLsnCjftobTm0bSOylYa8A6SL7raj2+Myclmua3E3BJK0LjLzR3WEOgCGoQQsOjfzXQgcca3pe6nC2Ak1mDJNw6j085+kR7W3UpwXcwLE0+nBwxTdcWXMZIMWQ9O7kFd5W7h1/0TbR5sVYszT4su13jd5UhbZi4KBzzvFpGKXg4gk9v2L6giqPRJ/WDdDtRo+VbAeDELg9xxoF/jJCC7Uv71FpGeERSJ2cJQSdjIU1bEfbPhL7mAjn+8nBre1otP/f4O4ZfrdHETMYt+zIB+XpTtHRlgxqQO1pSFcsgJMr1Id6dvv1RpiEyGo0iSUY7hgnPd5jL81Ee88EU1Wk68unA7bQYN51cFD5zBLhpsnGawpsS+peAmzxgRDODIqONdkhG81DWE72fsbm80="
  file_glob: true
  file:
  - "deploy/*"
  skip_cleanup: true
  on:
    tags: true
- provider: npm
  email: serveradmin@octoblu.com
  api_key:
    secure: "cSjbyfGtpCNN7hOd7aU4yb/4iGGm5elJAMvBIML8nXIO5F6ryranlvEbnKPtvjzfXVuiV+EuJwo6GgahUBArSrlQdaSceZKVXESaSpqQ40Dugi6WHuJ9SGMK/iU+4bkBu0ph2KpBtwD8Wk7PkNpNfQr17Yu1n/+uPEn568veTkij1I+st7x2k1Z+FESf+RJKUtir5EebSy2JH3j7bjR9t64YABYxpsI+1L0pHRMTR2M+I8sAmINVboanVyFmP2dUlep8ZOhOHQGbpSNcmzDn/UOn6g8g/h/vj3C9fKB+p/rE5fN1sNVPHUExX+dzc5jby76SDSmuhbFXbHc0UOTmpp4D/M3sqqsszQA2xd6AP7jg4kMEY7/xxxitceSdgGgcSjKuXEk48zgYuQvLvFAWP0pSakL0mSVLLu1hslCty/s/FdqWT6gbegFzZprFdoGO4vAY/lOZ8eJUWKQdSxCXBJ/tUt6uQEDgTdhTR0alj51HufYnLjZx3omtNi4qWzn9FvwdHBBo16Q7yrDM3A4DSf0KvJyIAHE1S3KfwryRRhbj2aOYkz7r8keEy4mqFnBkcZVLswDxBDiehGjQrB4RPXLgCbQNNTqHplkwTqtQIg/UoH8FN/yBCI+IcOK2Z3n9r5BKr8W1oTXaxb+q8Mfmo2TlOq4X1SFoND7/acGSMXU="
  on:
    tags: true
    condition: "$NPM_PUBLISH = true"
